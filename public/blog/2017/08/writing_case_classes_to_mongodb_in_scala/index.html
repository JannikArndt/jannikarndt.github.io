<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Writing case classes to MongoDB in Scala | Jannik Arndt</title>
<meta name="keywords" content="Scala, Case Class, MongoDB, Tutorial, How-To" />
<meta name="description" content="Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for java.time classes such as ZonedDateTime, LocalDate or Duration.
This example uses the official Mongo Scala Driver in version 2.x and the bsoncodec project by Ralph Schaer.">
<meta name="author" content="Jannik Arndt">
<link rel="canonical" href="https://www.jannikarndt.de/blog/2017/08/writing_case_classes_to_mongodb_in_scala/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d843783cdb609239c8dc02b76fad025d8b7eefdda1eed08f8f38dfb97c60cfc2.css" integrity="sha256-2EN4PNtgkjnI3AK3b60CXYt&#43;792h7tCPjzjfuXxgz8I=" rel="preload stylesheet" as="style">
<link rel="preload" href="/favicons/apple-touch-icon.png" as="image">
<link rel="icon" href="https://www.jannikarndt.de/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.jannikarndt.de/favicons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.jannikarndt.de/favicons/favicon-16x16.png">
<link rel="apple-touch-icon" href="https://www.jannikarndt.de/favicons/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.jannikarndt.de/favicons/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Writing case classes to MongoDB in Scala" />
<meta property="og:description" content="Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for java.time classes such as ZonedDateTime, LocalDate or Duration.
This example uses the official Mongo Scala Driver in version 2.x and the bsoncodec project by Ralph Schaer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.jannikarndt.de/blog/2017/08/writing_case_classes_to_mongodb_in_scala/" /><meta property="og:image" content="https://www.jannikarndt.de/jannik.jpg"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-08-19T10:05:00&#43;01:00" />
<meta property="article:modified_time" content="2017-08-19T10:05:00&#43;01:00" /><meta property="og:site_name" content="Jannik Arndt" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.jannikarndt.de/jannik.jpg"/>

<meta name="twitter:title" content="Writing case classes to MongoDB in Scala"/>
<meta name="twitter:description" content="Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for java.time classes such as ZonedDateTime, LocalDate or Duration.
This example uses the official Mongo Scala Driver in version 2.x and the bsoncodec project by Ralph Schaer."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://www.jannikarndt.de/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Writing case classes to MongoDB in Scala",
      "item": "https://www.jannikarndt.de/blog/2017/08/writing_case_classes_to_mongodb_in_scala/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writing case classes to MongoDB in Scala",
  "name": "Writing case classes to MongoDB in Scala",
  "description": "Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for java.time classes such as ZonedDateTime, LocalDate or Duration.\nThis example uses the official Mongo Scala Driver in version 2.x and the bsoncodec project by Ralph Schaer.\n",
  "keywords": [
    "Scala", "Case Class", "MongoDB", "Tutorial", "How-To"
  ],
  "articleBody": "Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for java.time classes such as ZonedDateTime, LocalDate or Duration.\nThis example uses the official Mongo Scala Driver in version 2.x and the bsoncodec project by Ralph Schaer.\nThe solution First: A complete working example:\nimport java.math.BigDecimal import java.time.{LocalDate, LocalDateTime} import scala.concurrent.Await import scala.concurrent.duration._ import scala.language.postfixOps object MongoDbExample { def main(args: Array[String]): Unit = { val myParcel = Parcel( sender = Address(\"Online Shop 3000\", \"E-Commerce-Street\", \"Berlin\"), receiver = Address(\"Jannik\", \"Fun-Street\", \"Hamburg\"), sent = LocalDate.of(2017, 8, 12), received = Some(LocalDateTime.of(2017, 8, 19, 10, 24)), contents = Seq(Content(\"Cool Robot\", new BigDecimal(\"39.99\")), Content(\"Drone\", new BigDecimal(\"199.99\"))) ) Await.result(DB.parcels.insertOne(myParcel).toFuture, 10 seconds) val allParcels = Await.result(DB.parcels.find().toFuture(), 10 seconds) allParcels.foreach(println) } } case class Parcel(sender: Address, receiver: Address, sent: LocalDate, received: Option[LocalDateTime], contents: Seq[Content]) case class Address(name: String, street: String, city: String) case class Content(name: String, price: BigDecimal) object DB { import ch.rasc.bsoncodec.math._ import ch.rasc.bsoncodec.time._ import org.bson.codecs.configuration.CodecRegistries import org.bson.codecs.configuration.CodecRegistries._ import org.mongodb.scala.bson.codecs.DEFAULT_CODEC_REGISTRY import org.mongodb.scala.bson.codecs.Macros._ import org.mongodb.scala.{MongoClient, MongoCollection, MongoDatabase} private val customCodecs = fromProviders(classOf[Parcel], classOf[Address], classOf[Content]) private val javaCodecs = CodecRegistries.fromCodecs( new LocalDateTimeDateCodec(), new LocalDateDateCodec(), new BigDecimalStringCodec()) private val codecRegistry = fromRegistries(customCodecs, javaCodecs, DEFAULT_CODEC_REGISTRY) private val database: MongoDatabase = MongoClient().getDatabase(\"TrackingData\") .withCodecRegistry(codecRegistry) val parcels: MongoCollection[Parcel] = database.getCollection(\"Parcels\") } This results in the following entry:\n{ \"_id\" : ObjectId(\"5997f9ff96ddbad1d424981d\"), \"sender\" : { \"name\" : \"Online Shop 3000\", \"street\" : \"E-Commerce-Street\", \"city\" : \"Berlin\" }, \"receiver\" : { \"name\" : \"Jannik\", \"street\" : \"Fun-Street\", \"city\" : \"Hamburg\" }, \"sent\" : ISODate(\"2017-08-12T00:00:00.000Z\"), \"received\" : ISODate(\"2017-08-19T10:24:00.000Z\"), \"contents\" : [ { \"name\" : \"Cool Robot\", \"price\" : \"39.99\" }, { \"name\" : \"Drone\", \"price\" : \"199.99\" } ] } How to get there Adding codecs for custom classes The magic is obviously hidden in the DB object. Following just the driver documentation, one might start with this simpler version:\nobject DB { import org.mongodb.scala.{MongoClient, MongoCollection, MongoDatabase} private val database: MongoDatabase = MongoClient().getDatabase(\"TrackingData\") val parcels: MongoCollection[Parcel] = database.getCollection(\"Parcels\") } This results in the exception\nException in thread \"main\" org.bson.codecs.configuration.CodecConfigurationException: Can't find a codec for class de.jannikarndt.MongoDbExample.Parcel. Googleing for the problem, you find quite many outdated solutions, such as salat, which is still maintained but uses the outdated casbah driver (aka “version 1”).\nAlex Landa explains, that version 2 of the driver fixes this problem with macros:\n The Codec class is generated during the compile time and then added to the default codec registry (using the fromRegistries method).\n So the next step is to create codecs for all custom classes and tell the MongoClient to use these codecs:\nobject DB { import org.bson.codecs.configuration.CodecRegistries._ import org.mongodb.scala.bson.codecs.DEFAULT_CODEC_REGISTRY import org.mongodb.scala.bson.codecs.Macros._ import org.mongodb.scala.{MongoClient, MongoCollection, MongoDatabase} private val customCodecs = fromProviders(classOf[Parcel], classOf[Address], classOf[Content]) private val codecRegistry = fromRegistries(customCodecs, DEFAULT_CODEC_REGISTRY) private val database: MongoDatabase = MongoClient().getDatabase(\"TrackingData\") .withCodecRegistry(codecRegistry) val parcels: MongoCollection[Parcel] = database.getCollection(\"Parcels\") } Adding codecs for system classes This brings us one step further, to the next exception:\nException in thread \"main\" org.bson.codecs.configuration.CodecConfigurationException: Can't find a codec for class java.time.LocalDate. If you try to add classOf[LocalDate] to the list, you get a compile error, stating that\nError:(41, 106) java.time.LocalDate does not have a constructor private val customCodecs = fromProviders(classOf[Parcel], classOf[Address], classOf[Content], classOf[LocalDate]) You (or a macro you invoke) cannot add code to the standard java classes. At this point, you would have to write a codec yourself, extending / implementing org.bson.codecs.Codec and overriding encode and decode.\nLuckily, Ralph Schaer has already done this — not just for LocalDate but for most of java.time, java.sql, URLs, BigDecimal, javax.money, and more, and for many types you can even decide how to encode them, i.e. to date, document or string.\nThat’s what the lines\nprivate val javaCodecs = CodecRegistries.fromCodecs( new LocalDateTimeDateCodec(), new LocalDateDateCodec(), new BigDecimalStringCodec()) private val codecRegistry = fromRegistries(customCodecs, javaCodecs, DEFAULT_CODEC_REGISTRY) in the final solution (see top of the page) are about.\n",
  "wordCount" : "623",
  "inLanguage": "en",
  "datePublished": "2017-08-19T10:05:00+01:00",
  "dateModified": "2017-08-19T10:05:00+01:00",
  "author":{
    "@type": "Person",
    "name": "Jannik Arndt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.jannikarndt.de/blog/2017/08/writing_case_classes_to_mongodb_in_scala/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jannik Arndt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.jannikarndt.de/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.jannikarndt.de/" accesskey="h" title="JannikArndt.de (Alt + H)">
                <img src="/favicons/apple-touch-icon.png" alt="logo" aria-label="logo"
                    height="35">JannikArndt.de</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.jannikarndt.de/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://www.jannikarndt.de/archive/" title="blog">
                    <span>blog</span>
                </a>
            </li>
            <li>
                <a href="https://www.jannikarndt.de/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://www.jannikarndt.de/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://www.jannikarndt.de/">Home</a>&nbsp;»&nbsp;<a href="https://www.jannikarndt.de/blog/">Blog</a></div>
    <h1 class="post-title">
      Writing case classes to MongoDB in Scala
    </h1>
    <div class="post-meta">August 19, 2017&nbsp;·&nbsp;Jannik Arndt
</div>
  </header> 
  <div class="post-content"><p>Storing case classes in a MongoDB database is incredibly easy, once you know how. The same goes for <code>java.time</code> classes such as <code>ZonedDateTime</code>, <code>LocalDate</code> or <code>Duration</code>.</p>
<p>This example uses the official <a href="https://mvnrepository.com/artifact/org.mongodb.scala/mongo-scala-driver_2.11">Mongo Scala Driver</a> in version 2.x and the <a href="https://github.com/ralscha/bsoncodec">bsoncodec</a> project by <a href="https://github.com/ralscha">Ralph Schaer</a>.</p>
<h2 id="the-solution">The solution<a hidden class="anchor" aria-hidden="true" href="#the-solution">#</a></h2>
<p>First: A complete working example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">java.time.</span><span class="o">{</span><span class="nc">LocalDate</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.Await</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.language.postfixOps</span>

<span class="k">object</span> <span class="nc">MongoDbExample</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">myParcel</span> <span class="k">=</span> <span class="nc">Parcel</span><span class="o">(</span>
            <span class="n">sender</span> <span class="k">=</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&#34;Online Shop 3000&#34;</span><span class="o">,</span> <span class="s">&#34;E-Commerce-Street&#34;</span><span class="o">,</span> <span class="s">&#34;Berlin&#34;</span><span class="o">),</span>
            <span class="n">receiver</span> <span class="k">=</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&#34;Jannik&#34;</span><span class="o">,</span> <span class="s">&#34;Fun-Street&#34;</span><span class="o">,</span> <span class="s">&#34;Hamburg&#34;</span><span class="o">),</span>
            <span class="n">sent</span> <span class="k">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">12</span><span class="o">),</span>
            <span class="n">received</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">19</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">24</span><span class="o">)),</span>
            <span class="n">contents</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">Content</span><span class="o">(</span><span class="s">&#34;Cool Robot&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">&#34;39.99&#34;</span><span class="o">)),</span> 
                           <span class="nc">Content</span><span class="o">(</span><span class="s">&#34;Drone&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">&#34;199.99&#34;</span><span class="o">)))</span>
        <span class="o">)</span>

        <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">parcels</span><span class="o">.</span><span class="n">insertOne</span><span class="o">(</span><span class="n">myParcel</span><span class="o">).</span><span class="n">toFuture</span><span class="o">,</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">)</span>

        <span class="k">val</span> <span class="n">allParcels</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">parcels</span><span class="o">.</span><span class="n">find</span><span class="o">().</span><span class="n">toFuture</span><span class="o">(),</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">)</span>
        <span class="n">allParcels</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Parcel</span><span class="o">(</span><span class="n">sender</span><span class="k">:</span> <span class="kt">Address</span><span class="o">,</span> 
                  <span class="n">receiver</span><span class="k">:</span> <span class="kt">Address</span><span class="o">,</span> 
                  <span class="n">sent</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">,</span> 
                  <span class="n">received</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">LocalDateTime</span><span class="o">],</span> 
                  <span class="n">contents</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Content</span><span class="o">])</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Address</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">street</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">city</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Content</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigDecimal</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">DB</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">ch.rasc.bsoncodec.math._</span>
    <span class="k">import</span> <span class="nn">ch.rasc.bsoncodec.time._</span>
    <span class="k">import</span> <span class="nn">org.bson.codecs.configuration.CodecRegistries</span>
    <span class="k">import</span> <span class="nn">org.bson.codecs.configuration.CodecRegistries._</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.bson.codecs.DEFAULT_CODEC_REGISTRY</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.bson.codecs.Macros._</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.</span><span class="o">{</span><span class="nc">MongoClient</span><span class="o">,</span> <span class="nc">MongoCollection</span><span class="o">,</span> <span class="nc">MongoDatabase</span><span class="o">}</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">customCodecs</span> <span class="k">=</span> <span class="n">fromProviders</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">],</span> 
                                             <span class="n">classOf</span><span class="o">[</span><span class="kt">Address</span><span class="o">],</span> 
                                             <span class="n">classOf</span><span class="o">[</span><span class="kt">Content</span><span class="o">])</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">javaCodecs</span> <span class="k">=</span> <span class="nc">CodecRegistries</span><span class="o">.</span><span class="n">fromCodecs</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">LocalDateTimeDateCodec</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nc">LocalDateDateCodec</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nc">BigDecimalStringCodec</span><span class="o">())</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">codecRegistry</span> <span class="k">=</span> <span class="n">fromRegistries</span><span class="o">(</span><span class="n">customCodecs</span><span class="o">,</span> 
                                               <span class="n">javaCodecs</span><span class="o">,</span> 
                                               <span class="nc">DEFAULT_CODEC_REGISTRY</span><span class="o">)</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">database</span><span class="k">:</span> <span class="kt">MongoDatabase</span> <span class="o">=</span> <span class="nc">MongoClient</span><span class="o">().</span><span class="n">getDatabase</span><span class="o">(</span><span class="s">&#34;TrackingData&#34;</span><span class="o">)</span>
                                                       <span class="o">.</span><span class="n">withCodecRegistry</span><span class="o">(</span><span class="n">codecRegistry</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">parcels</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">]</span> <span class="k">=</span> <span class="n">database</span><span class="o">.</span><span class="n">getCollection</span><span class="o">(</span><span class="s">&#34;Parcels&#34;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><p>This results in the following entry:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">&#34;5997f9ff96ddbad1d424981d&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;sender&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Online Shop 3000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;street&#34;</span> <span class="p">:</span> <span class="s2">&#34;E-Commerce-Street&#34;</span><span class="p">,</span>
        <span class="nt">&#34;city&#34;</span> <span class="p">:</span> <span class="s2">&#34;Berlin&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;receiver&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Jannik&#34;</span><span class="p">,</span>
        <span class="nt">&#34;street&#34;</span> <span class="p">:</span> <span class="s2">&#34;Fun-Street&#34;</span><span class="p">,</span>
        <span class="nt">&#34;city&#34;</span> <span class="p">:</span> <span class="s2">&#34;Hamburg&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;sent&#34;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&#34;2017-08-12T00:00:00.000Z&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;received&#34;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&#34;2017-08-19T10:24:00.000Z&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;contents&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="p">{</span>
            <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Cool Robot&#34;</span><span class="p">,</span>
            <span class="nt">&#34;price&#34;</span> <span class="p">:</span> <span class="s2">&#34;39.99&#34;</span>
        <span class="p">},</span> 
        <span class="p">{</span>
            <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Drone&#34;</span><span class="p">,</span>
            <span class="nt">&#34;price&#34;</span> <span class="p">:</span> <span class="s2">&#34;199.99&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><h2 id="how-to-get-there">How to get there<a hidden class="anchor" aria-hidden="true" href="#how-to-get-there">#</a></h2>
<h3 id="adding-codecs-for-custom-classes">Adding codecs for custom classes<a hidden class="anchor" aria-hidden="true" href="#adding-codecs-for-custom-classes">#</a></h3>
<p>The magic is obviously hidden in the <code>DB</code> object. Following <em>just</em> the <a href="http://mongodb.github.io/mongo-scala-driver/2.1/getting-started/quick-tour/">driver documentation</a>, one might start with this simpler version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">DB</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.</span><span class="o">{</span><span class="nc">MongoClient</span><span class="o">,</span> <span class="nc">MongoCollection</span><span class="o">,</span> <span class="nc">MongoDatabase</span><span class="o">}</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">database</span><span class="k">:</span> <span class="kt">MongoDatabase</span> <span class="o">=</span> <span class="nc">MongoClient</span><span class="o">().</span><span class="n">getDatabase</span><span class="o">(</span><span class="s">&#34;TrackingData&#34;</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">parcels</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">]</span> <span class="k">=</span> <span class="n">database</span><span class="o">.</span><span class="n">getCollection</span><span class="o">(</span><span class="s">&#34;Parcels&#34;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><p>This results in the exception</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Exception in thread &quot;main&quot; org.bson.codecs.configuration.CodecConfigurationException: Can't find a codec for class de.jannikarndt.MongoDbExample.Parcel.
</code></pre><p>Googleing for the problem, you find quite many outdated solutions, such as <a href="https://github.com/salat/salat">salat</a>, which is still maintained but uses the outdated <a href="https://github.com/mongodb/casbah/">casbah</a> driver (aka &ldquo;version 1&rdquo;).</p>
<p>Alex Landa <a href="http://trainologic.com/working-case-classes-mongodb-scala/">explains</a>, that version 2 of the driver fixes this problem with macros:</p>
<blockquote>
<p>The Codec class is generated during the compile time and then added to the default codec registry (using the fromRegistries method).</p>
</blockquote>
<p>So the next step is to create codecs for all custom classes and tell the MongoClient to use these codecs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">DB</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">org.bson.codecs.configuration.CodecRegistries._</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.bson.codecs.DEFAULT_CODEC_REGISTRY</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.bson.codecs.Macros._</span>
    <span class="k">import</span> <span class="nn">org.mongodb.scala.</span><span class="o">{</span><span class="nc">MongoClient</span><span class="o">,</span> <span class="nc">MongoCollection</span><span class="o">,</span> <span class="nc">MongoDatabase</span><span class="o">}</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">customCodecs</span> <span class="k">=</span> <span class="n">fromProviders</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">],</span> 
                                             <span class="n">classOf</span><span class="o">[</span><span class="kt">Address</span><span class="o">],</span> 
                                             <span class="n">classOf</span><span class="o">[</span><span class="kt">Content</span><span class="o">])</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">codecRegistry</span> <span class="k">=</span> <span class="n">fromRegistries</span><span class="o">(</span><span class="n">customCodecs</span><span class="o">,</span> <span class="nc">DEFAULT_CODEC_REGISTRY</span><span class="o">)</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">database</span><span class="k">:</span> <span class="kt">MongoDatabase</span> <span class="o">=</span> <span class="nc">MongoClient</span><span class="o">().</span><span class="n">getDatabase</span><span class="o">(</span><span class="s">&#34;TrackingData&#34;</span><span class="o">)</span>
                                                       <span class="o">.</span><span class="n">withCodecRegistry</span><span class="o">(</span><span class="n">codecRegistry</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">parcels</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">]</span> <span class="k">=</span> <span class="n">database</span><span class="o">.</span><span class="n">getCollection</span><span class="o">(</span><span class="s">&#34;Parcels&#34;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><h3 id="adding-codecs-for-system-classes">Adding codecs for system classes<a hidden class="anchor" aria-hidden="true" href="#adding-codecs-for-system-classes">#</a></h3>
<p>This brings us one step further, to the next exception:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">Exception in thread &quot;main&quot; org.bson.codecs.configuration.CodecConfigurationException: Can't find a codec for class java.time.LocalDate.
</code></pre><p>If you try to add <code>classOf[LocalDate]</code> to the list, you get a compile error, stating that</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Error</span><span class="k">:</span><span class="o">(</span><span class="err">41</span><span class="o">,</span> <span class="err">106</span><span class="o">)</span> <span class="n">java</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="nc">LocalDate</span> <span class="n">does</span> <span class="n">not</span> <span class="n">have</span> <span class="n">a</span> <span class="n">constructor</span>
    <span class="k">private</span> <span class="k">val</span> <span class="n">customCodecs</span> <span class="k">=</span> <span class="n">fromProviders</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Parcel</span><span class="o">],</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">Address</span><span class="o">],</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">Content</span><span class="o">],</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">])</span>
</code></pre></div><p>You (or a macro you invoke) cannot add code to the standard java classes. At this point, you would have to write a <code>codec</code> yourself, extending / implementing <code>org.bson.codecs.Codec</code> and overriding <code>encode</code> and <code>decode</code>.</p>
<p>Luckily, <a href="https://github.com/ralscha">Ralph Schaer</a> has already done this — not just for <a href="https://github.com/ralscha/bsoncodec/blob/master/src/main/java/ch/rasc/bsoncodec/time/LocalDateDateCodec.java">LocalDate</a> but for <a href="https://github.com/ralscha/bsoncodec">most of <code>java.time</code>, <code>java.sql</code>, URLs, BigDecimal, <code>javax.money</code>, and more</a>, and for many types you can even decide how to encode them, i.e. to <code>date</code>, <code>document</code> or <code>string</code>.</p>
<p>That&rsquo;s what the lines</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala">    <span class="k">private</span> <span class="k">val</span> <span class="n">javaCodecs</span> <span class="k">=</span> <span class="nc">CodecRegistries</span><span class="o">.</span><span class="n">fromCodecs</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">LocalDateTimeDateCodec</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nc">LocalDateDateCodec</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nc">BigDecimalStringCodec</span><span class="o">())</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">codecRegistry</span> <span class="k">=</span> <span class="n">fromRegistries</span><span class="o">(</span><span class="n">customCodecs</span><span class="o">,</span> 
                                               <span class="n">javaCodecs</span><span class="o">,</span> 
                                               <span class="nc">DEFAULT_CODEC_REGISTRY</span><span class="o">)</span>
</code></pre></div><p>in the final solution (see top of the page) are about.</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.jannikarndt.de/tags/programming/">Programming</a></li>
      <li><a href="https://www.jannikarndt.de/tags/scala/">Scala</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://www.jannikarndt.de/">Jannik Arndt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
